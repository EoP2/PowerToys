parameters:
  - name: platform
    type: string
    default: ""

steps:
- ${{ if eq(parameters.platform, 'x64Win11') }}:
  - pwsh: |-
      try {
        # Check if already installed
        if (Get-Command "wt.exe" -ErrorAction SilentlyContinue) {
          Write-Host "Windows Terminal already installed"
          exit 0
        }
        
        Write-Host "Installing Windows Terminal via winget..."
        $process = Start-Process -FilePath "winget" -ArgumentList "install", "--id", "Microsoft.WindowsTerminal", "--accept-package-agreements", "--accept-source-agreements", "--silent" -Wait -PassThru -NoNewWindow
        
        if ($process.ExitCode -eq 0) {
          Write-Host "Windows Terminal installation completed successfully"
        } else {
          Write-Warning "Winget returned exit code $($process.ExitCode), but continuing..."
        }
      } catch {
        Write-Warning "Terminal installation via winget failed: $_"
        Write-Host "Continuing without Terminal..."
      }
      # Always exit with 0 to continue pipeline
      exit 0
    displayName: Install Windows Terminal (Win11 - winget)

- ${{ if eq(parameters.platform, 'x64Win10') }}:
  - powershell: |-
      try {
        # Check if already installed
        if (Get-Command "wt.exe" -ErrorAction SilentlyContinue) {
          Write-Host "Windows Terminal already installed"
          return
        }
        
        # Download and install Windows Terminal from GitHub
        Write-Host "Installing Windows Terminal from GitHub releases..."
        $url = "https://api.github.com/repos/microsoft/terminal/releases/latest"
        $release = Invoke-RestMethod -Uri $url
        $msixUrl = ($release.assets | Where-Object { $_.name -like "*msixbundle" }).browser_download_url
        
        if ($msixUrl) {
          $msixFile = "$env:TEMP\WindowsTerminal.msixbundle"
          Invoke-WebRequest -Uri $msixUrl -OutFile $msixFile
          Add-AppxPackage -Path $msixFile
          Remove-Item $msixFile -Force -ErrorAction SilentlyContinue
          Write-Host "Windows Terminal installed successfully"
        } else {
          Write-Warning "Could not find Terminal MSIX bundle"
        }
      } catch {
        Write-Warning "Terminal installation failed: $_"
        Write-Host "Continuing without Terminal..."
      }
    displayName: Install Windows Terminal (Win10 - Direct Download)

- pwsh: |-
    Write-Host "Checking for Windows Terminal..."
    if (Get-Command "wt.exe" -ErrorAction SilentlyContinue) {
      Write-Host "Windows Terminal found and available"
    } else {
      Write-Host "##[warning]Windows Terminal not found, but continuing..."
    }
  displayName: Check Windows Terminal
