<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="Microsoft.PowerToys.Settings.UI.Controls.FoundryLocalModelPicker"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:LanguageModelProvider"
    xmlns:toolkit="using:CommunityToolkit.WinUI.Controls"
    xmlns:local="using:Microsoft.PowerToys.Settings.UI.Controls"
    x:Name="Root"
    mc:Ignorable="d">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <Style x:Key="TagBorderStyle" TargetType="Border">
            <Setter Property="Background" Value="{ThemeResource LayerFillColorDefaultBrush}" />
            <Setter Property="BorderBrush" Value="{ThemeResource ControlStrongStrokeColorDefaultBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="8,2" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>
        <Style x:Key="TagTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Foreground" Value="{ThemeResource TextFillColorPrimaryBrush}" />
            <Setter Property="TextWrapping" Value="NoWrap" />
        </Style>
    </UserControl.Resources>

    <Grid>
        <ProgressRing
            x:Name="LoadingIndicator"
            Width="36"
            Height="36"
            HorizontalAlignment="Center"
            VerticalAlignment="Center" />

        <ScrollViewer
            x:Name="ModelsView"
            Visibility="Collapsed">
            <Grid Padding="16,12,16,16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <StackPanel
                    x:Name="NoModelsPanel"
                    Grid.Row="0"
                    Margin="0,0,0,16"
                    HorizontalAlignment="Center"
                    Orientation="Vertical"
                    Spacing="8">
                    <FontIcon
                        FontSize="24"
                        Glyph="&#xE74E;" />
                    <TextBlock
                        HorizontalAlignment="Center"
                        Style="{StaticResource BodyStrongTextBlockStyle}"
                        Text="No models downloaded"
                        TextAlignment="Center" />
                    <TextBlock
                        HorizontalAlignment="Center"
                        FontSize="12"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        Text="Download or add a local model below."
                        TextAlignment="Center"
                        TextWrapping="Wrap" />
                </StackPanel>

                <ListView
                    x:Name="CachedModelsListView"
                    Grid.Row="1"
                    MaxHeight="260"
                    SelectionMode="Single"
                    ItemsSource="{x:Bind CachedModels, Mode=OneWay}"
                    SelectionChanged="CachedModelsListView_SelectionChanged">
                    <ListView.Resources>
                        <Style TargetType="ListViewItem" BasedOn="{StaticResource DefaultListViewItemStyle}">
                            <Setter Property="Margin" Value="0,0,0,8" />
                        </Style>
                    </ListView.Resources>
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:ModelDetails">
                            <toolkit:SettingsCard
                                MinHeight="64"
                                Padding="18,12,18,12"
                                Background="{ThemeResource LayerFillColorAltBrush}">
                                <toolkit:SettingsCard.Resources>
                                    <Thickness x:Key="SettingsCardHeaderIconMargin">0,0,12,0</Thickness>
                                    <x:Double x:Key="SettingsCardWrapThreshold">320</x:Double>
                                </toolkit:SettingsCard.Resources>
                                <toolkit:SettingsCard.Header>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock
                                            VerticalAlignment="Center"
                                            Text="{x:Bind Name}"
                                            TextTrimming="CharacterEllipsis"
                                            ToolTipService.ToolTip="{x:Bind Name}" />
                                        <TextBlock
                                            Grid.Column="1"
                                            Margin="12,0,0,0"
                                            VerticalAlignment="Center"
                                            FontSize="12"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                            Text="{x:Bind local:FoundryLocalModelPicker.GetModelSizeText(Size), Mode=OneWay}"
                                            Visibility="{x:Bind local:FoundryLocalModelPicker.GetModelSizeVisibility(Size), Mode=OneWay}" />
                                    </Grid>
                                </toolkit:SettingsCard.Header>
                                <toolkit:SettingsCard.Description>
                                    <StackPanel Spacing="6">
                                        <TextBlock
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                            Text="{x:Bind Description}"
                                            TextWrapping="Wrap"
                                            ToolTipService.ToolTip="{x:Bind Description}" />
                                        <toolkit:WrapPanel HorizontalSpacing="4" VerticalSpacing="4">
                                            <Border
                                                Style="{StaticResource TagBorderStyle}"
                                                Visibility="{x:Bind local:FoundryLocalModelPicker.GetModelSizeVisibility(Size), Mode=OneWay}">
                                                <TextBlock
                                                    Style="{StaticResource TagTextStyle}"
                                                    Text="{x:Bind local:FoundryLocalModelPicker.GetModelSizeText(Size), Mode=OneWay}" />
                                            </Border>
                                            <ItemsRepeater
                                                ItemsSource="{x:Bind local:FoundryLocalModelPicker.GetDeviceTags(HardwareAccelerators), Mode=OneWay}"
                                                Visibility="{x:Bind local:FoundryLocalModelPicker.GetDeviceVisibility(HardwareAccelerators), Mode=OneWay}">
                                                <ItemsRepeater.Layout>
                                                    <StackLayout Orientation="Horizontal" Spacing="4" />
                                                </ItemsRepeater.Layout>
                                                <ItemsRepeater.ItemTemplate>
                                                    <DataTemplate x:DataType="x:String">
                                                        <Border Style="{StaticResource TagBorderStyle}">
                                                            <TextBlock Style="{StaticResource TagTextStyle}" Text="{x:Bind}" />
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsRepeater.ItemTemplate>
                                            </ItemsRepeater>
                                            <Border
                                                Style="{StaticResource TagBorderStyle}"
                                                Visibility="{x:Bind local:FoundryLocalModelPicker.GetLicenseVisibility(License), Mode=OneWay}">
                                                <TextBlock
                                                    Style="{StaticResource TagTextStyle}"
                                                    Text="{x:Bind local:FoundryLocalModelPicker.GetLicenseShortText(License), Mode=OneWay}" />
                                                <ToolTipService.ToolTip>
                                                    <TextBlock Text="{x:Bind License, Mode=OneWay}" TextWrapping="Wrap" />
                                                </ToolTipService.ToolTip>
                                            </Border>
                                        </toolkit:WrapPanel>
                                    </StackPanel>
                                </toolkit:SettingsCard.Description>
                            </toolkit:SettingsCard>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <StackPanel
                    x:Name="DownloadSection"
                    Grid.Row="2"
                    Margin="0,16,0,0"
                    Orientation="Horizontal"
                    Spacing="12">
                    <DropDownButton Content="Download model" IsEnabled="{x:Bind HasDownloadableModels, Mode=OneWay}">
                        <DropDownButton.Flyout>
                            <Flyout x:Name="DownloadModelsFlyout" Placement="BottomEdgeAlignedLeft">
                                <StackPanel Width="420" Spacing="8">
                                    <TextBlock
                                        FontWeight="SemiBold"
                                        Text="Available models" />
                                    <ScrollViewer MaxHeight="320">
                                        <ItemsRepeater ItemsSource="{x:Bind DownloadableModels, Mode=OneWay}">
                                            <ItemsRepeater.Layout>
                                                <StackLayout Spacing="6" />
                                            </ItemsRepeater.Layout>
                                            <ItemsRepeater.ItemTemplate>
                                                <DataTemplate>
                                                    <Button
                                                        Padding="12,10"
                                                        HorizontalAlignment="Stretch"
                                                        IsEnabled="{Binding CanDownload}"
                                                        Style="{StaticResource SubtleButtonStyle}"
                                                        Tag="{Binding}"
                                                        Click="DownloadItemButton_Click">
                                                        <Grid ColumnSpacing="12">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*" />
                                                                <ColumnDefinition Width="Auto" />
                                                            </Grid.ColumnDefinitions>
                                                            <StackPanel Spacing="6">
                                                                <TextBlock
                                                                    FontWeight="SemiBold"
                                                                    Text="{Binding Name}"
                                                                    TextWrapping="Wrap" />
                                                                <TextBlock
                                                                    FontSize="12"
                                                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                                    Text="{Binding Description}"
                                                                    TextWrapping="Wrap" />
                                                                <toolkit:WrapPanel HorizontalSpacing="4" VerticalSpacing="4">
                                                                    <Border
                                                                        Style="{StaticResource TagBorderStyle}"
                                                                        Visibility="{Binding HasSizeTag, Converter={StaticResource BoolToVisibilityConverter}}">
                                                                        <TextBlock
                                                                            Style="{StaticResource TagTextStyle}"
                                                                            Text="{Binding SizeTag}" />
                                                                    </Border>
                                                                    <ItemsRepeater
                                                                        ItemsSource="{Binding DeviceTags}"
                                                                        Visibility="{Binding HasDeviceTags, Converter={StaticResource BoolToVisibilityConverter}}">
                                                                        <ItemsRepeater.Layout>
                                                                            <StackLayout Orientation="Horizontal" Spacing="4" />
                                                                        </ItemsRepeater.Layout>
                                                                        <ItemsRepeater.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <Border Style="{StaticResource TagBorderStyle}">
                                                                                    <TextBlock Style="{StaticResource TagTextStyle}" Text="{Binding}" />
                                                                                </Border>
                                                                            </DataTemplate>
                                                                        </ItemsRepeater.ItemTemplate>
                                                                    </ItemsRepeater>
                                                                    <Border
                                                                        Style="{StaticResource TagBorderStyle}"
                                                                        Visibility="{Binding HasLicenseTag, Converter={StaticResource BoolToVisibilityConverter}}">
                                                                        <TextBlock
                                                                            Style="{StaticResource TagTextStyle}"
                                                                            Text="{Binding LicenseTag}" />
                                                                        <ToolTipService.ToolTip>
                                                                            <TextBlock Text="{Binding ModelDetails.License}" TextWrapping="Wrap" />
                                                                        </ToolTipService.ToolTip>
                                                                    </Border>
                                                                </toolkit:WrapPanel>
                                                                <ProgressBar
                                                                    Height="4"
                                                                    Maximum="100"
                                                                    Minimum="0"
                                                                    Value="{Binding ProgressPercent}"
                                                                    Visibility="{Binding ProgressVisibility}" />
                                                            </StackPanel>
                                                            <TextBlock
                                                                Grid.Column="1"
                                                                VerticalAlignment="Center"
                                                                FontWeight="SemiBold"
                                                                Text="{Binding ActionLabel}" />
                                                        </Grid>
                                                    </Button>
                                                </DataTemplate>
                                            </ItemsRepeater.ItemTemplate>
                                        </ItemsRepeater>
                                    </ScrollViewer>
                                </StackPanel>
                            </Flyout>
                        </DropDownButton.Flyout>
                    </DropDownButton>
                </StackPanel>

                <TextBlock
                    x:Name="StatusTextBlock"
                    Grid.Row="3"
                    Margin="0,16,0,0"
                    FontSize="12"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    TextWrapping="Wrap" />
            </Grid>
        </ScrollViewer>

        <Grid
            x:Name="NotAvailableGrid"
            Visibility="Collapsed">
            <StackPanel
                Margin="48,0,48,48"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Orientation="Vertical"
                Spacing="8">
                <Image
                    Width="36"
                    Source="ms-appx:///Assets/Settings/Icons/Models/FoundryLocal.svg" />
                <TextBlock
                    FontWeight="SemiBold"
                    Text="Foundry Local is not installed on this device."
                    TextAlignment="Center"
                    TextWrapping="Wrap" />
                <TextBlock
                    FontSize="12"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    IsTextSelectionEnabled="True"
                    TextAlignment="Center"
                    TextWrapping="Wrap">
                    <Run Text="Install Foundry Local to download and use local models." />
                </TextBlock>
                <HyperlinkButton
                    Content="Learn how to install Foundry Local"
                    NavigateUri="https://aka.ms/fl-install-from-gallery" />
            </StackPanel>
        </Grid>

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="StateGroup">
                <VisualState x:Name="ShowLoading" />
                <VisualState x:Name="ShowModels">
                    <VisualState.Setters>
                        <Setter Target="LoadingIndicator.Visibility" Value="Collapsed" />
                        <Setter Target="NotAvailableGrid.Visibility" Value="Collapsed" />
                        <Setter Target="ModelsView.Visibility" Value="Visible" />
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="ShowNotAvailable">
                    <VisualState.Setters>
                        <Setter Target="LoadingIndicator.Visibility" Value="Collapsed" />
                        <Setter Target="NotAvailableGrid.Visibility" Value="Visible" />
                        <Setter Target="ModelsView.Visibility" Value="Collapsed" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
    </Grid>
</UserControl>
